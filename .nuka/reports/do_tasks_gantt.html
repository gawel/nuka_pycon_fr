<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf8" />
      <style>
        body {
          font: 12px sans-serif;
        }
        #header {
          position: fixed;
          top: 0px;
          margin-bottom: 5px;
          width: 100%;
          height:60px;
        }
        .controls, .legends {
            padding: .3em;
        }
        .legend {
            padding:.3em;
        }
        #status {
          position: fixed;
          top: 0px;
          right: 0px;
          width: 40%;
          background-color: #fff;
          z-index: 100000;
          border: thin solid #000;
          padding: 2px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        #zoom {
            width: 30%;
        }
        #tick {
            width: 3em;
        }
        #wrapper {
            overflow:none;
            padding-top:50px;
            padding-bottom:1px;
        }
        #first {
            position:absolute;
            top: auto;
            left: 0px;
            width: 200px;
            vertical-align: top;
            padding-top: 20px;
            text-align:right;
            background-color: #fff;
        }
        #first > div {
            border-top: 1px solid rgb(200, 200, 200);
            border-right: 1px solid rgb(200, 200, 200);
        }
        #first div div {
            overflow: hidden;
            border-bottom: 1px solid rgb(200, 200, 200);
            padding-right: 3px;
        }
        svg {
            margin-left: 190px;
        }
        .task {
            fill: rgb(230, 230, 230);
            background-color: rgb(230, 230, 230);
        }
        .show_line {
            fill: rgb(240, 240, 240);
            background-color: rgb(240, 240, 240);
        }
        .hide_line {
            fill: rgb(255, 255, 255);
            background-color: rgb(255, 255, 255);
        }
        .pre_process, .api_call {
            fill: rgb(248, 223, 223);
            background-color: rgb(248, 223, 223);
        }
        .process {
            fill: rgb(223, 248, 223);
            background-color: rgb(223, 248, 223);
        }
        .sh {
            fill: rgb(223, 223, 248);
            background-color: rgb(223, 223, 248);
        }
        line {
            stroke:rgb(200,200,200);
            stroke-width:1;
        }
        .show {
            display: block;
        }
        .hide {
            display: none;
        }
      </style>
      <script>
        var host_datas = {
  "hosts":{
    "pyconfr":{
      "host":"pyconfr",
      "tasks":[
        {
          "type":"task",
          "name":"boot()",
          "short_name":"boot",
          "start":0.0,
          "time":0.0575809479,
          "rc":0,
          "row":1,
          "filename":"nuka\/task.py",
          "lineno":48,
          "funcs":[
            {
              "name":"start()",
              "type":"api_call",
              "start":0.0491483212,
              "time":0.0035998821,
              "parent":"b4d713eb32634b3994e7d12cd611c58b",
              "latency":null,
              "remote_calls":[

              ],
              "uid":"caf667fbabcd476ebae010ecce5b0380",
              "start_str":"0.0",
              "time_str":"0.0"
            },
            {
              "name":"containers()",
              "type":"api_call",
              "start":0.0527575016,
              "time":0.0026192665,
              "parent":"b4d713eb32634b3994e7d12cd611c58b",
              "latency":null,
              "remote_calls":[

              ],
              "uid":"78ef0066ec504686aa420a75a6de25a4",
              "start_str":"0.1",
              "time_str":"0.0"
            }
          ],
          "remote_calls":[

          ],
          "uid":"b4d713eb32634b3994e7d12cd611c58b",
          "start_str":"0.0",
          "time_str":"0.1"
        },
        {
          "type":"task",
          "name":"setup()",
          "short_name":"setup",
          "start":0.0576062202,
          "time":0.4053554535,
          "rc":0,
          "row":2,
          "filename":"nuka\/task.py",
          "lineno":48,
          "funcs":[
            {
              "name":"subprocess(nuka\/script.py)",
              "type":"process",
              "start":0.0715084076,
              "time":0.3913612366,
              "parent":"47e3f2d041a74f38be83219a67c54a43",
              "latency":0.3880341053,
              "remote_calls":[

              ],
              "uid":"b5637ec990234022be7adc7abc9fc15f",
              "start_str":"0.1",
              "time_str":"0.4",
              "latency_str":"0.4"
            }
          ],
          "remote_calls":[

          ],
          "uid":"47e3f2d041a74f38be83219a67c54a43",
          "start_str":"0.1",
          "time_str":"0.4"
        },
        {
          "type":"task",
          "name":"tasks.mytask({})",
          "short_name":"tasks.mytask",
          "start":0.4630117416,
          "time":0.1445777416,
          "rc":0,
          "row":3,
          "filename":".\/do_tasks.py",
          "lineno":9,
          "funcs":[
            {
              "name":"subprocess(nuka\/script.py)",
              "type":"process",
              "start":0.4631063938,
              "time":0.1444237232,
              "parent":"5abae6941b9e47ee83e15ac41b02f3b9",
              "latency":0.1405541897,
              "remote_calls":[
                {
                  "type":"sh",
                  "start":0.6036605835,
                  "name":"sh(['ls', '\/var'])",
                  "time":0.0017910004,
                  "parent":"5abae6941b9e47ee83e15ac41b02f3b9",
                  "rc":0,
                  "uid":"a15c3ca31fe341b49451a2eea3ca5108",
                  "start_str":"0.6",
                  "time_str":"0.0"
                }
              ],
              "uid":"d781cda996d241549dd0189191db8acc",
              "start_str":"0.5",
              "time_str":"0.1",
              "latency_str":"0.1"
            }
          ],
          "remote_calls":[

          ],
          "uid":"5abae6941b9e47ee83e15ac41b02f3b9",
          "start_str":"0.5",
          "time_str":"0.1"
        },
        {
          "type":"task",
          "name":"teardown()",
          "short_name":"teardown",
          "start":0.6081802845,
          "time":0.0683705807,
          "rc":0,
          "row":4,
          "filename":"nuka\/task.py",
          "lineno":48,
          "funcs":[

          ],
          "remote_calls":[

          ],
          "uid":"301eb5da006042378ddce32b526a5dad",
          "start_str":"0.6",
          "time_str":"0.1"
        }
      ],
      "stats":[
        {
          "name":"tasks.mytask",
          "calls":1,
          "time":"0.145",
          "remote_time":"0.004",
          "avg_time":"0.145",
          "avg_remote_time":"0.004"
        },
        {
          "name":"setup",
          "calls":1,
          "time":"0.405",
          "remote_time":"0.003",
          "avg_time":"0.405",
          "avg_remote_time":"0.003"
        },
        {
          "name":"boot",
          "calls":1,
          "time":"0.058",
          "remote_time":"0.000",
          "avg_time":"0.058",
          "avg_remote_time":"0.000"
        },
        {
          "name":"teardown",
          "calls":1,
          "time":"0.068",
          "remote_time":"0.000",
          "avg_time":"0.068",
          "avg_remote_time":"0.000"
        }
      ],
      "total_time":0.6765508652,
      "real_time":0.6075894833,
      "total_time_str":"0.7",
      "real_time_str":"0.6"
    }
  },
  "total_time":0.6765508652,
  "total_tasks":4
}
      </script>
  </head>
  <body>
      <div id="header">
          <div class="controls">
              <select id="host">
              </select>

              <label for="tick">Tick:</label>
              <input type="number" id="tick" value="60" />

              <label for="zoom">Zoom:</label>
              <input type="range" id="zoom" min="1" max="10" step="1" value="1" />

              <label>Legend</label>
              <span class="legend task">task</span>
              <span class="legend pre_process">func / api call</span>
              <span class="legend process">subprocess</span>
              <span class="legend sh">remote process</span>
          </div>
      </div>
      <div id="status" class="hide">
      </div>
      <div id="wrapper">
          <div id="first"></div>
          <div id="svg"></div>
      </div>
      <script src="https://code.jquery.com/jquery-3.1.1.js"
              integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
              crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.js"
              integrity="sha256-IOnIx061QKBF2umT3sr/FYV/Pj504RsuFEWY5s3KL7Y="
              crossorigin="anonymous"></script>
      <script>
// include "/reports/gantt.js.j2"

/*global $, d3, window, document, host_datas */
// vim:filetype=javascript

var line_height = 20,
    height = (host_datas.total_tasks + 1) * line_height,
    tick = $('#tick'),
    zoom = $('#zoom'),
    host = null;

// set an almost right value for tick
if (host_datas.total_time < 30) {
    tick.val("1");
} else if (host_datas.total_time < 150) {
    tick.val("5");
} else if (host_datas.total_time < 300) {
    tick.val("10");
} else if (host_datas.total_time < 600) {
    tick.val("30");
} else {
    tick.val("60");
}

var ts = d3.select('#status');

// mouseover task / remote calls
function mouseover(task, func, sh) {
   ts.selectAll('table').remove();
   var table = ts.append('table');
   var tr = table.append('tr');
   tr.append('td').text(task.filename + ':' + task.lineno);
   tr.append('td').text('time');
   tr.append('td').text('lat.');
   tr = table.append('tr');
   tr.append('td').append('b').html(task.name);
   tr.append('td').append('b').text(task.time_str);
   tr.append('td').text('');
   task.funcs.forEach(function(f) {
        var ftr = table.append('tr');
        if (func && func.uid === f.uid) {
            ftr.attr('class', f.type);
        }
        ftr.append('td').text(f.name);
        ftr.append('td').text(f.time_str);
        ftr.append('td').text(f.latency_str || '');
        f.remote_calls.forEach(function(s) {
            var str = table.append('tr');
            if (sh && sh.uid === s.uid) {
                str.attr('class', s.type);
            }
            str.append('td').text(s.name);
            str.append('td').text(s.time_str);
            str.append('td').text('');
        });
    });
   ts.attr('class', 'show');
   $('#first_' + task.uid).attr('class', 'show_line');
   $('#line_' + task.uid).attr('class', 'show_line');
}

function mouseout(task) {
   ts.attr('class', 'hide');
   $('#first_' + task.uid).attr('class', 'hide_line');
   $('#line_' + task.uid).attr('class', 'hide_line');
}

// change first collumn pos on scroll
$(window).scroll(function() {
    $('#first').css('left', window.scrollX + 'px');
});

// draw svg
var svg = d3.select('#svg')
    .append("svg")
    .attr("class", "chart")
    .attr("height", height)
    .append("g")
    .attr("class", "g-chart")
    .attr("height", height);

// draw line and rect
function draw() {

    var host_data = host_datas.hosts[$('#host').val()];

    // remove elements
    svg.selectAll('rect').remove();
    svg.selectAll('line').remove();
    svg.selectAll('text').remove();

    // draw first collumn labels
    d3.select('#first').selectAll('div').remove();
    d3.select('#first')
       .append('div')
       .selectAll('#first')
       .data(host_data.tasks).enter()
       .append("div")
       .style("height", function() {
           return (line_height - 1) + 'px';
       })
       .text(function(d) { return d.short_name; })
       .attr('id', function(d) { return 'first_' + d.uid; })
       .on("mouseover", function(d) { return mouseover(d); } )
       .on("mouseout", function(d) { return mouseout(d); });

    // parameters
    var i = 0,
        tick_value = parseInt(tick.val(), 10),
        coef = (($(window).width() - 220) / host_data.total_time) * parseInt(zoom.val(), 10);
    coef = parseInt(coef, 10);

    // draw lines rects
    svg.selectAll('g')
       .data(host_data.tasks).enter()
       .append("rect")
       .attr("x", 0)
       .attr("y", function(d) { return d.row * line_height; })
       .attr('width', host_datas.total_time * coef + 10)
       .attr("height", function() { return line_height; })
       .attr('id', function(d) { return 'line_' + d.uid; })
       .attr('class', 'hide_line')
       .on("mouseover", function(d) { return mouseover(d); } )
       .on("mouseout", function(d) { return mouseout(d); });

    svg.selectAll('g')
       .data(host_data.tasks).enter()
       .append("line")
       .attr("x1", 0)
       .attr("y1", function(d) { return (d.row * line_height) + line_height; })
       .attr('x2', host_datas.total_time * coef + 10)
       .attr("y2", function(d) { return (d.row * line_height) + line_height; });

    // draw x grid
    do {
        svg
            .append('line')
            .attr('x1', i)
            .attr('y1', 0)
            .attr('x2', i)
            .attr('y2', $('#first > div').height() + line_height);
        svg
            .append('text')
            .attr('x', i + 2)
            .attr('y', 10)
            .attr('fill', 'black')
            .text(parseInt(i / coef, 10) + 's');
        i += tick_value * coef;
    }
    while (i < host_data.total_time * coef);

    // draw tasks rects
    svg.selectAll('g')
       .data(host_data.tasks).enter()
       .append("rect")
       .attr("x", function(d) { return d.start * coef; })
       .attr("y", function(d) { return d.row * line_height; })
       .attr("height", line_height)
       .attr("width", function(d) {return d.time * coef;})
       .attr("class", function(d) {return d.type;})
       .on("mouseover", function(d) { return mouseover(d); } )
       .on("mouseout", function(d) { return mouseout(d); })
       .attr('id', function(d) {
            // funcs
            svg.selectAll('g')
               .data(d.funcs).enter()
               .append("rect")
               .attr("x", function(f) { return f.start * coef; })
               .attr("y", function() { return d.row * line_height; })
               .attr("height", line_height - 3)
               .attr("width", function(f) { return f.time * coef; })
               .attr("class", function(f) { return f.type; })
               .on("mouseover", function(f) { return mouseover(d, f); } )
               .on("mouseout", function() { return mouseout(d); })
               .attr('id', function(f) {
                   // remote calls
                    svg.selectAll('g')
                       .data(f.remote_calls).enter()
                       .append("rect")
                       .attr("x", function(s) { return s.start * coef; })
                       .attr("y", function() { return d.row * line_height; })
                       .attr("height", line_height - 10)
                       .attr("width", function(s) { return s.time * coef; })
                       .attr("class", function(s) { return s.type; })
                       .on("mouseover", function(s) { return mouseover(d, f, s); } )
                       .on("mouseout", function() { return mouseout(d); });
               });

       });


    d3.select('svg').attr('width', host_datas.total_time * coef + 10);
    svg.attr('width', host_datas.total_time * coef + 10);
    $('#wrapper').css('width', host_datas.total_time * coef + 10);
}

// select
Object.keys(host_datas.hosts).forEach(function(key) {
    host = host_datas.hosts[key];
    d3.select('#host')
        .on('change', draw)
        .append('option')
        .attr('value', key)
        .text(function() {
            return key +
                ' (tasks(' + host.tasks.length + ')' +
                ' time(' + host.real_time_str + '))';
                });
});

// redraw when zoom or tick change
d3.select('#zoom').on('change', draw);
d3.select('#tick').on('change', draw);

// first draw
draw();


// end include "/reports/gantt.js.j2"
      </script>
  </body>
</html>
